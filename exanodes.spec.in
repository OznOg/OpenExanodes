#
# Copyright 2002, 2012 Seanodes Ltd http://www.seanodes.com. All rights
# reserved and protected by French, UK, U.S. and other countries' copyright laws.
# This file is part of Exanodes project and is subject to the terms
# and conditions defined in the LICENSE file which is present in the root
# directory of the project.
#

# Backport RPM4.4 conditional build stuff on old distros (CentOS4).

%if %{?with:0}%{!?with:1}
%define with() %{expand:%%{?with_%{1}:1}%%{!?with_%{1}:0}}
%define without() %{expand:%%{?with_%{1}:0}%%{!?with_%{1}:1}}
%define bcond_with() %{expand:%%{?_with_%{1}:%%global with_%{1} 1}}
%define bcond_without() %{expand:%%{!?_without_%{1}:%%global with_%{1} 1}}
%endif

# Define (or not) with_xxx macros depending on the default value and the
# --with xxx and --without xxx options passed to rpmbuild.

# @Option: Compile cluster side (nodes) (default=yes)
%bcond_without nodes
# @Option: Compile the monitoring daemon (default=no)
%bcond_with monitoring
# @Option: Compile CLI (default=yes)
%bcond_without cli
# @Option: With test (default=yes)
%bcond_without test
# @Option: With tools (default=yes)
%bcond_without tools
# @Option: Set the FORTIFY_SOURCE=2 macro to add extra checks (default=yes)
%bcond_without fortify
# @Option: Stop compiling on warnings (default=yes)
%bcond_without werror
# @Option: Use dkms to compile kernel modules (default=yes)
%bcond_without dkms
# @Option: Compile SElinux policy (default=yes)
%bcond_without selinux
# @Option: Build and run unit tests (default=no)
%bcond_with ut
# @Option: Build and run unit tests that requires to be root (default=no)
%bcond_with ut_root
# @Option: Disable Linux block device (default=no)
%bcond_without bdev
# @Option: Enable performance instrumentation (default=no)
%bcond_with perf

# @Option: Compile exanodes with the debugging code (default=no)
%bcond_with debug
# @Option: Compile exanodes with the tracing code (default=no)
%bcond_with trace
# @Option: Enable userspace memory allocation checks (default=no)
%bcond_with memtrace
# @Option: Enable kernel space memory allocation checks (default=no)
%bcond_with kmemtrace
# @Option: Enable Yaourt support (default=no)
%bcond_with yaourt
# @Option: Don't strip binairies and don't build the debug rpm (default=no)
%bcond_with symbols
# @Option: Enable code coverage analysis (default=no)
%bcond_with coverage
# @Option: Compile documentation - NOT SUPPORTED (default=no)
%bcond_with docs
# @Option: Enable filesystems (default=no)
%bcond_with filesystems
# @Option: Enable token manager (default=no)
%bcond_with tm

# Disable auto-generation of the debug package

%define debug_package %{nil}
%define __os_install_post /usr/lib/rpm/brp-compress


# Detect the distribution

%define rheldistro  0
%define distro_release unknown

%if %(cat /etc/*release | sort -u | grep -E "CentOS release 5|Scientific Linux SL release 5" | wc -l) > 0
%define rheldistro      1
%define distro_release  rhel5
%endif

%if %(cat /etc/*release | sort -u | grep -E "CentOS.* release 6" | wc -l) > 0
%define rheldistro      1
%define distro_release  rhel6
%endif

%if %(cat /etc/*release | sort -u | grep -E "CentOS.* release 7" | wc -l) > 0
%define rheldistro      1
%define distro_release  rhel7
%endif

# Detect the kernel version

%define linuxver %(uname -r)


%define	name            @CMAKE_PROJECT_NAME@
%define version         @EXA_EDITION_TAG@.@EXA_VERSION@.@CURRENT_DATE@
%define release         %distro_release
%define tarball_name    @EXA_TARBALL_NAME@

Summary: 		Seanodes Exanodes @EXA_EDITION_STR@
Name: 			%name
Version: 		%version
Vendor:			Seanodes
Packager:		Seanodes

Release: 		%{release}
License: 		PROPRIETARY
Group: 			System
URL: 			http://www.seanodes.com
Source: 		%{tarball_name}.tar.gz
BuildRoot: 		%{_tmppath}/%{tarball_name}-buildroot
BuildRequires:		pkgconfig
BuildRequires:		cmake >= 2.6
BuildRequires:          perl-String-CRC32 >= 1.4
%if %with ut
BuildRequires:		seanodes-unittesting-devel >= 1.0
%endif

%description
Exanodes virtualizes physical internal storage of cluster nodes
into a shared, performant, flexible and reliable storage space.

%if %with docs
%{error:Docs cannot be part of the RPMs generated by this spec file.}
%endif

%if %without symbols
%package debug
Summary: 		Debug information for package %{name}
Group: 			Development/Debug
AutoReqProv: 		0

%description debug
This package provides debug information for package %{name}.
Debug information is useful when developing applications that use this
package or when debugging this package.
%endif

%if %with cli

%package cli
Summary:        CLI (command line interface) for Exanodes
Group: 		System
Version:  	%{version}
BuildRequires:  libxml2-devel >= 2.6
Requires:       libxml2 >= 2.6
BuildRequires:	boost-devel >= 1.33.1
BuildRequires:	perl
Requires:       %{name}-policy
# Workaround for Mandriva that don't autodetect .pm files that don't begin
# with an uppercase letter.
Provides:       perl(constantes)
Provides:       perl(exa_adm_protocol)
Provides:       perl(exa_constants)
Provides:       perl(exa_error)
Provides:       perl(exa_names)

%description cli
CLI (command line interface) for Exanodes

%package tools-cli
Summary:        Additional CLI commands for Exanodes
Group:          System
Version:        %{version}
BuildRequires:  libxml2-devel >= 2.6
Requires:       libxml2 >= 2.6
BuildRequires:	boost-devel >= 1.33.1
BuildRequires:	perl
Requires:       %{name}-cli

%description tools-cli
Additional CLI commands for Exanodes

%package policy-empty
Summary:        Empty Exanodes policy
Group:          System
Version:        %{version}
Provides:       %{name}-policy = %{version}-%{release}

%description policy-empty
Empty Exanodes policy

%endif # cli


%if %with nodes

%if %rheldistro
%if %with selinux
%package selinux-policy
Summary:        Exanodes policy file for SElinux
Group:          System
Version:        %{version}
BuildRequires:  selinux-policy-devel
Requires:       selinux-policy-targeted, selinux-policy, policycoreutils

%description selinux-policy
Exanodes policy file for Security-Enhanced Linux (use on nodes)
%endif #selinux-policy
%endif #rheldistro


%package admind
Summary:        Exanodes exa_admind daemon (to use on nodes)
Group:          System
Version:        %{version}
BuildRequires:  libxml2-devel >= 2.6
Requires:       libxml2 >= 2.6
BuildRequires:  openssl-devel
Requires:       openssl
BuildRequires:  wget >= 1.0

%description admind
Exanodes exa_admind daemon (to use on nodes)


%package nodes
Summary:        Exanodes daemons (to use on nodes)
Group: 		System
Version:  	%{version}
Requires:       %{name}-kernel = %{version}-%{release}
Requires(pre):  %{name}-kernel = %{version}-%{release}
Requires(post): %{name}-kernel = %{version}-%{release}
Requires:       %{name}-admind = %{version}-%{release}
Requires(pre):  %{name}-admind = %{version}-%{release}
Requires(post): %{name}-admind = %{version}-%{release}
Requires:	logrotate
Requires:	procps, psmisc
%if %with yaourt
Requires:	yaourt-yaourtyaourtlib
BuildRequires:	yaourt-yaourtlib
%endif

%description nodes
Exanodes daemons (to use on nodes)

%if %with dkms
%package -n dkms-%{name}
Summary:        Sources of Exanodes kernel modules to be build with dkms (to use on nodes)
Group: 		System
Version:  	%{version}
Requires:       dkms, make, gcc
Requires(post): dkms, make, gcc
Requires(preun):dkms
Provides:	%{name}-kernel = %{version}-%{release}

%description -n dkms-%{name}
Sources of Exanodes kernel modules to be build with dkms (to use on nodes)
%else
%package kernel-%{linuxver}
Summary:        Exanodes kernel modules (to use on nodes)
Group: 		System
Version:  	%{version}
%if %without dkms
BuildRequires:  kernel = %{linuxver}
BuildRequires:  kernel-devel = %{linuxver}
Requires:       kernel = %{linuxver}
%endif
Provides:	%{name}-kernel = %{version}-%{release}

%description kernel-%{linuxver}
Exanodes kernel modules (to use on nodes)
%endif

%package test-nodes
Summary:        Test utilities commands for Exanodes (to use on nodes)
Group: 		System
Version:  	%{version}
Requires:	%{name}-nodes = %{version}-%{release}
Requires:       bonnie++, blocktools, stress, netperf


%description test-nodes
Test utilities commands for Exanodes (to use on nodes)


%package tools-nodes
Summary:        Tools for Exanodes (to use on nodes)
Group: 		System
Version:  	%{version}
Requires:	%{name}-nodes = %{version}-%{release}


%description tools-nodes
Tools for Exanodes (to use on nodes)

%endif # nodes


%if %with monitoring
%package monitoring
Summary:        Exanodes monitoring system
Group: 		System
Version:  	%{version}
Requires:       %{name}-admind = %{version}-%{release}
Requires(pre):  %{name}-admind = %{version}-%{release}
Requires(post): %{name}-admind = %{version}-%{release}
Requires:	logrotate
Requires:       net-snmp
BuildRequires:  net-snmp-devel net-snmp-perl, net-snmp-utils, libsmi, lm_sensors-devel, openssl-devel

%description monitoring
Exanodes monitoring system

%endif # monitoring

%package token-manager
Summary:        Token manager for Exanodes
Group: 		System
Version:  	%{version}
BuildRequires:  libxml2-devel >= 2.6
Requires:       libxml2 >= 2.6
BuildRequires:	boost-devel >= 1.33.1
BuildRequires:	perl

%description token-manager
Token manager for Exanodes, required for two-nodes clusters.

%prep
%setup -q -n %{tarball_name}

%build
echo -- Destination directories: ------
echo prefix: %{_prefix}
echo sbin dir: %{_sbindir}
echo bin dir: %{_bindir}
echo sysconf dir: %{_sysconfdir}
echo cache dir: %{cache_dir}
echo log dir: %{log_dir}
echo pid dir: %{pid_dir}
echo ----------------------------------
mkdir build
cd build
cmake .. \
  -DCMAKE_VERBOSE_MAKEFILE=1 \
  %{?with_symbols:-DCMAKE_BUILD_TYPE=RelWithDebInfo} \
  %{?!with_symbols:-DCMAKE_BUILD_TYPE=Release} \
  %{?!with_bdev:-DWITH_BDEV=FALSE} \
  %{?!with_cli:-DWITH_CLI=FALSE} \
  %{?!with_nodes:-DWITH_NODES=FALSE} \
%if %rheldistro
  %{?with_selinux:-DWITH_SELINUX=TRUE} \
%endif
  %{?with_monitoring:-DWITH_MONITORING=TRUE} \
  %{?with_debug:-DCMAKE_BUILD_TYPE=Debug} \
  %{?with_trace:-DWITH_TRACE=TRUE} \
  %{?with_memtrace:-DWITH_MEMTRACE=TRUE} \
  %{?with_kmemtrace:-DWITH_KMEMTRACE=TRUE} \
  %{?!with_test:-DWITH_TEST=FALSE} \
  %{?with_tools:-DWITH_TOOLS=TRUE} \
  %{?with_yaourt:-DWITH_YAOURT=TRUE} \
  %{?!with_dkms:-DWITH_DKMS=FALSE} \
  %{?with_filesystems:-DWITH_FS=TRUE} \
  %{?with_coverage:-DCMAKE_BUILD_TYPE=Coverage} \
  %{?with_docs:-DWITH_DOCS=TRUE} \
  %{?with_perf:-DWITH_PERF=TRUE} \
  %{?!with_ut:-DWITH_UT=FALSE} \
  %{?!with_ut_root:-DWITH_UT_ROOT=FALSE} \
  -DCMAKE_INSTALL_PREFIX=%{_prefix} \
  -DSBIN_DIR=%{_sbindir} \
  -DBIN_DIR=%{_bindir} \
  -DSYSCONF_DIR=%{_sysconfdir} \
  -DCACHE_DIR=%{cache_dir} \
  -DDKMS_DIR=%{_usrsrc}/%{tarball_name} \
  -DLINUXVER=%{linuxver}

make -j`/usr/bin/getconf _NPROCESSORS_ONLN`

%if %with ut
ctest -V
%endif

%install
rm -rf $RPM_BUILD_ROOT
cd build
make DESTDIR=$RPM_BUILD_ROOT install

%if %without symbols
##########################
#### Managing debug files
##########################
# Mainly inspired by find-debuginfo.sh
# Removing the devel files

debugdir="${RPM_BUILD_ROOT}/usr/lib/debug"

for f in `find $RPM_BUILD_ROOT -type f ! -regex "${RPM_BUILD_ROOT}/lib/modules/.*" -exec file {} \; | \
	sed -n -e 's/^\(.*\):[  ]*ELF.*, not stripped/\1/p'`
do
	dn=$(dirname $f | sed -n -e "s#^$RPM_BUILD_ROOT##p")
	bn=$(basename $f .debug).debug

	debugdn="${debugdir}${dn}"
	debugfn="${debugdn}/${bn}"

	mkdir -p "${debugdn}"
	objcopy --only-keep-debug "$f" "${debugfn}"
	objcopy --strip-debug "$f"
	objcopy --add-gnu-debuglink="${debugfn}" "$f"
done

find ${RPM_BUILD_ROOT}/usr/lib/debug -type f | sed -n -e "s#^$RPM_BUILD_ROOT##p" > debugfiles.list

%files debug -f build/debugfiles.list
%defattr(-,root,root)
################################
### End of debug file management
################################
%endif

%clean
rm -rf $RPM_BUILD_ROOT

%if %with cli

%files cli
%defattr(-,root,root,-)
%doc tools/exa_batch_init tools/exa_batch_cleanup
%{_bindir}/exa_cli
%{_bindir}/exa_clcreate
%{_bindir}/exa_cldelete
%{_bindir}/exa_cldiskadd
%{_bindir}/exa_cldiskdel
%{_bindir}/exa_clinfo
%if %with monitoring
%{_bindir}/exa_clmonitorstart
%{_bindir}/exa_clmonitorstop
%endif
%{_bindir}/exa_clnodeadd
%{_bindir}/exa_clnodedel
%{_bindir}/exa_clnoderecover
%{_bindir}/exa_clnodestart
%{_bindir}/exa_clnodestop
%{_bindir}/exa_clreconnect
%{_bindir}/exa_clstart
%{_bindir}/exa_clstats
%{_bindir}/exa_clstop
%{_bindir}/exa_cltrace
%{_bindir}/exa_cltune
%{_bindir}/exa_cllicense
%{_bindir}/exa_dgcreate
%{_bindir}/exa_dgdelete
%{_bindir}/exa_dgdiskrecover
%{_bindir}/exa_dgdiskadd
%{_bindir}/exa_dgstart
%{_bindir}/exa_dgstop
%{_bindir}/exa_vlcreate
%{_bindir}/exa_vldelete
%{_bindir}/exa_vlresize
%{_bindir}/exa_vlstart
%{_bindir}/exa_vlstop
%{_bindir}/exa_vltune
%if %with filesystems
%{_bindir}/exa_fscheck
%{_bindir}/exa_fscreate
%{_bindir}/exa_fsdelete
%{_bindir}/exa_fsresize
%{_bindir}/exa_fsstart
%{_bindir}/exa_fsstop
%{_bindir}/exa_fstune
%endif # filesystems
%{_bindir}/exa_expand
%{_bindir}/exa_unexpand
%{_bindir}/exa_install
%{_bindir}/exa_makeconfig
%{_bindir}/exa_gatherinfo
%{_mandir}/man1/exa_clcreate.1.*
%{_mandir}/man1/exa_cldelete.1.*
%{_mandir}/man1/exa_cldiskadd.1.*
%{_mandir}/man1/exa_cldiskdel.1.*
%{_mandir}/man1/exa_clinfo.1.*
%if %with monitoring
%{_mandir}/man1/exa_clmonitorstart.1.*
%{_mandir}/man1/exa_clmonitorstop.1.*
%endif
%{_mandir}/man1/exa_clnodeadd.1.*
%{_mandir}/man1/exa_clnodedel.1.*
%{_mandir}/man1/exa_clnoderecover.1.*
%{_mandir}/man1/exa_clnodestart.1.*
%{_mandir}/man1/exa_clnodestop.1.*
%{_mandir}/man1/exa_clreconnect.1.*
%{_mandir}/man1/exa_clstart.1.*
%{_mandir}/man1/exa_clstats.1.*
%{_mandir}/man1/exa_clstop.1.*
%{_mandir}/man1/exa_cltrace.1.*
%{_mandir}/man1/exa_cltune.1.*
%{_mandir}/man1/exa_cllicense.1.*
%{_mandir}/man1/exa_dgcreate.1.*
%{_mandir}/man1/exa_dgdelete.1.*
%{_mandir}/man1/exa_dgdiskrecover.1.*
%{_mandir}/man1/exa_dgdiskadd.1.*
%{_mandir}/man1/exa_dgstart.1.*
%{_mandir}/man1/exa_dgstop.1.*
%{_mandir}/man1/exa_vlcreate.1.*
%{_mandir}/man1/exa_vldelete.1.*
%{_mandir}/man1/exa_vlresize.1.*
%{_mandir}/man1/exa_vlstart.1.*
%{_mandir}/man1/exa_vlstop.1.*
%{_mandir}/man1/exa_vltune.1.*
%if %with filesystems
%{_mandir}/man1/exa_fscheck.1.*
%{_mandir}/man1/exa_fscreate.1.*
%{_mandir}/man1/exa_fsdelete.1.*
%{_mandir}/man1/exa_fsresize.1.*
%{_mandir}/man1/exa_fsstart.1.*
%{_mandir}/man1/exa_fsstop.1.*
%{_mandir}/man1/exa_fstune.1.*
%endif # filesystems
%{_mandir}/man1/exa_expand.1.*
%{_mandir}/man1/exa_unexpand.1.*
%{_mandir}/man1/exa_install.1.*
%{_mandir}/man1/exa_makeconfig.1.*
%{_mandir}/man1/exa_gatherinfo.1.*

%if %with tools
%files tools-cli
%{_bindir}/exa_clitools
%{_bindir}/exa_dgreset
%{_bindir}/exa_dgcheck
%{_mandir}/man1/exa_dgreset.1.*
%{_mandir}/man1/exa_dgcheck.1.*
%{_datadir}/%{name}/test/constantes.pm
%{_datadir}/%{name}/test/exa_*.pm
%endif # tools

%files policy-empty
%{_datadir}/%{name}/default_tunables.conf

%endif # cli

%if %with nodes

# !!! During an upgrade, the order is %pre(new), replace files, %post(new), %preun(old), %postun(old) !!!
# $1: 0=uninstall, 1=install, 2=upgrade

%pre nodes
if [ "$1" = "2" ]; then # upgrade
	echo "--- Trying to stop Exanodes before the upgrade... ---"
	/etc/init.d/%{name} try-stop > /dev/null 2>&1;
	if [ $? -ne 0 ]; then
		echo "--- WARNING ! Failed to stop Exanodes. You should restart it manually after the upgrade. ---"
	else
		echo "--- Exanodes is stopped. ---"
	fi
fi

%if %with dkms
%post -n dkms-%{name}
echo "--- Build and install kernel modules with dkms. ---"
dkms add -m %{name} -v @EXA_EDITION_TAG@-@EXA_VERSION@ --rpm_safe_upgrade &&
dkms build -m %{name} -v @EXA_EDITION_TAG@-@EXA_VERSION@ --rpm_safe_upgrade --no-clean-kernel &&
dkms install -m %{name} -v @EXA_EDITION_TAG@-@EXA_VERSION@ --rpm_safe_upgrade --force
true
%else
%post kernel-%{linuxver}
echo "--- Update kernel modules dependencies. ---"
/sbin/depmod -e %{linuxver}
%endif

%if %rheldistro
%if %with selinux

%post selinux-policy
echo "--- Insert SELinux exafsd module. ---"
/usr/sbin/semodule -i /usr/share/selinux/targeted/exa_fsd.pp
if [ $? -ne 0 ]; then
	echo "--- WARNING ! Failed to insert SELinux exafsd module. ---"
fi

%preun selinux-policy
/usr/sbin/semodule -l | grep -q exafsd
if [ $? -eq 0 ]; then
	echo "--- Remove SELinux exafsd module. ---"
	/usr/sbin/semodule -r exafsd
fi

%endif # %selinux
%endif # %rheldistro

%post nodes

echo "--- Add Exanodes as service. ---"
if [ -x /sbin/chkconfig ]; then
  /sbin/chkconfig --add %{name} || :
elif [ -x /usr/sbin/update-rc.d ]; then
  /usr/sbin/update-rc.d %{name} defaults 98 33 || :
fi
echo "--- Starting Exanodes... ---"
/etc/init.d/%{name} start > /dev/null 2>/dev/null
if [ $? -ne 0 ]; then
	echo "--- WARNING ! Failed to start Exanodes. ---"
else
	echo "--- Exanodes is started. ---"
fi

%preun nodes
if [ "$1" = "0" ]; then # uninstall
	echo "--- Trying to stop Exanodes before the uninstall... ---"
	/etc/init.d/%{name} try-stop >/dev/null 2>&1;
	if [ $? -ne 0 ]; then
		echo "--- WARNING ! Failed to stop Exanodes. ---"
	else
		echo "--- Exanodes is stopped. ---"
	fi
	if [ -x /sbin/chkconfig ]; then
		/sbin/chkconfig --del %{name} || :
	elif [ -x /usr/sbin/update-rc.d ]; then
		/usr/sbin/update-rc.d -f %{name} remove || :
	fi
fi

%if %with dkms
%preun -n dkms-%{name}
echo "--- Uninstall kernel modules with dkms. ---"
dkms remove -m %{name} -v @EXA_EDITION_TAG@-@EXA_VERSION@ --rpm_safe_upgrade --all
true
%endif

%post token-manager
echo "--- Add token manager as service. ---"
if [ -x /sbin/chkconfig ]; then
  /sbin/chkconfig --add token_manager || :
elif [ -x /usr/sbin/update-rc.d ]; then
  /usr/sbin/update-rc.d token_manager defaults 97 34 || :
fi
echo "--- Starting Token manager... ---"
/etc/init.d/token_manager start > /dev/null 2>/dev/null
if [ $? -ne 0 ]; then
	echo "--- WARNING ! Failed to start token manager. ---"
else
	echo "--- Token manager is started. ---"
fi

%preun token-manager
if [ "$1" = "0" ]; then # uninstall
	echo "--- Trying to stop token manager before the uninstall... ---"
	/etc/init.d/%{name} stop >/dev/null 2>&1;
	if [ $? -ne 0 ]; then
		echo "--- WARNING ! Failed to stop token manager. ---"
	else
		echo "--- Token manager is stopped. ---"
	fi
	if [ -x /sbin/chkconfig ]; then
		/sbin/chkconfig --del token_manager || :
	elif [ -x /usr/sbin/update-rc.d ]; then
		/usr/sbin/update-rc.d -f token_manager remove || :
	fi
fi

%files nodes
%defattr(-,root,root,-)
%{_sbindir}/exa_csupd
%if %with filesystems
%{_sbindir}/exa_fsd
%{_sbindir}/exa_fsscript
%dir %{_sysconfdir}/%{name}
%config(noreplace) %{_sysconfdir}/%{name}/postmount.d/postmount.template
%config(noreplace) %{_sysconfdir}/%{name}/preumount.d/preumount.template
%endif
%{_sbindir}/exa_msgd
%{_sbindir}/exa_serverd
%{_sbindir}/exa_clientd
%if %with monitoring
%{_sbindir}/exa_md
%endif
%config(noreplace) /etc/logrotate.d/%{name}
/etc/init.d/%{name}
%config %{_sysconfdir}/udev/rules.d/40-%{name}.rules
%if %with perf
%config(noreplace) %{_sysconfdir}/%{name}/exaperf.conf
%endif

%files admind
%{_sbindir}/exa_admind

%if %with monitoring
%files monitoring
%{_sbindir}/exa_agentx
/usr/share/snmp/mibs/SEANODES.MIB
%config(noreplace) /etc/logrotate.d/exa_agentx
%endif

%if %with dkms
%files -n dkms-%{name}
%defattr(-,root,root,-)
%dir %{_usrsrc}/%{tarball_name}
%{_usrsrc}/%{tarball_name}/Makefile.dkms
%{_usrsrc}/%{tarball_name}/dkms.conf
%{_usrsrc}/%{tarball_name}/copy_symvers
%{_usrsrc}/%{tarball_name}/os/include/os_inttypes.h
%{_usrsrc}/%{tarball_name}/os/include/os_assert.h
%{_usrsrc}/%{tarball_name}/common/lib/Makefile
%{_usrsrc}/%{tarball_name}/common/lib/exa_common_kernel.[ch]
%{_usrsrc}/%{tarball_name}/common/lib/exa_select_kernel.[ch]
%{_usrsrc}/%{tarball_name}/common/lib/exa_socket_kernel.[ch]
%{_usrsrc}/%{tarball_name}/common/lib/exa_thread_name_kernel.[ch]
%{_usrsrc}/%{tarball_name}/common/include/exa_names.h
%{_usrsrc}/%{tarball_name}/common/include/exa_error.h
%{_usrsrc}/%{tarball_name}/common/include/exa_assert.h
%{_usrsrc}/%{tarball_name}/common/include/exa_constants.h
%{_usrsrc}/%{tarball_name}/common/include/exa_math.h
%{_usrsrc}/%{tarball_name}/rdev/src/Makefile
%{_usrsrc}/%{tarball_name}/rdev/src/rdev_kmodule.c
%{_usrsrc}/%{tarball_name}/rdev/src/rdev_kmodule.h
%{_usrsrc}/%{tarball_name}/rdev/include/exa_rdev.h
%if %with bdev
%{_usrsrc}/%{tarball_name}/target/linux_bd_target/module/Makefile
%{_usrsrc}/%{tarball_name}/target/linux_bd_target/module/*.c
%{_usrsrc}/%{tarball_name}/target/linux_bd_target/include/bd_user.h
%{_usrsrc}/%{tarball_name}/target/linux_bd_target/module/bd_user_bd.h
%{_usrsrc}/%{tarball_name}/target/linux_bd_target/module/bd_list.h
%{_usrsrc}/%{tarball_name}/target/linux_bd_target/module/bd_user_fops.h
%{_usrsrc}/%{tarball_name}/target/linux_bd_target/module/bd_user_kernel.h
%{_usrsrc}/%{tarball_name}/target/linux_bd_target/module/bd_log.h
%endif
%else
%files kernel-%{linuxver}
%defattr(-,root,root,-)
%dir /lib/modules/%{linuxver}/kernel/%{name}
/lib/modules/%{linuxver}/kernel/%{name}/exa_common.ko
%if %with bdev
/lib/modules/%{linuxver}/kernel/%{name}/exa_bd.ko
%endif
/lib/modules/%{linuxver}/kernel/%{name}/exa_rdev.ko
%endif

%if %with test
%files test-nodes
%defattr(-,root,root,-)
%{_sbindir}/exatest_get_md5
%{_sbindir}/exatest_mydd
%{_sbindir}/exatest_odirect
%{_sbindir}/exatest_gentree
%endif

%if %with tools
%files tools-nodes
%defattr(-,root,root,-)
%{_sbindir}/exa_gdb
%{_sbindir}/exa_enable_valgrind
%{_sbindir}/exatest_kill
%{_sbindir}/exa_rdev_sbtool
%{_sbindir}/exa_rdev_test
%{_sbindir}/exa_rdev_broken
%if %with filesystems
%{_sbindir}/exa_fstool
%endif
%endif

%if %rheldistro
%if %with selinux
%files selinux-policy
%{_datadir}/selinux/targeted/exa_fsd.pp
%endif
%endif

%endif # nodes

%files token-manager
%defattr(-,root,root,-)
/etc/init.d/token_manager
%config(noreplace) /etc/logrotate.d/token_manager.logrotate
%{_sbindir}/token_manager
%{_sbindir}/tm_tool

%changelog

