/*
 * Copyright 2002, 2009 Seanodes Ltd http://www.seanodes.com. All rights
 * reserved and protected by French, UK, U.S. and other countries' copyright laws.
 * This file is part of Exanodes project and is subject to the terms
 * and conditions defined in the LICENSE file which is present in the root
 * directory of the project.
 */

#ifndef SCSI_H
#define SCSI_H

#define SCSI_CDB_MAX_FIXED_LENGTH 16 /* spc3r23 3.1.17 */

#define TEST_UNIT_READY 0x00
#define REZERO_UNIT 0x01
#define REQUEST_SENSE 0x03
#define FORMAT_UNIT 0x04
#define FORMAT_MEDIUM 0x04
#define READ_BLOCK_LIMITS 0x05
#define REASSIGN_BLOCKS_SCSI 0x07
#define INITIALIZE_ELEMENT_STATUS 0x07
#define READ_6 0x08
#define RECEIVE 0x08
#define GET_MESSAGE_6 0x08
#define WRITE_6 0x0A
#define SEND_6 0x0A
#define SEND_MESSAGE_6 0x0A
#define SEEK_6 0x0B
#define SET_CAPACITY 0x0B
#define SLEW_AND_PRINT 0x0B
#define READ_REVERSE_6 0x0F
#define WRITE_FILEMARKS_6 0x10
#define SYNCHRONIZE_BUFFER 0x10
#define SPACE_6 0x11
#define INQUIRY 0x12
#define VERIFY_6 0x13
#define RECOVER_BUFFERED_DATA 0x14
#define MODE_SELECT_6 0x15
#define RESERVE_6 0x16
#define RESERVE_ELEMENT_6 0x16
#define RELEASE_6 0x17
#define RELEASE_ELEMENT_6 0x17
#define COPY 0x18
#define ERASE_6 0x19
#define MODE_SENSE_6 0x1A
#define START_STOP_UNIT 0x1B
#define LOAD_UNLOAD 0x1B
#define STOP_PRINT 0x1B
#define OPEN_CLOSE_IMPORT_EXPORT_ELEMENT 0x1B
#define RECEIVE_DIAGNOSTIC_RESULTS 0x1C
#define SEND_DIAGNOSTIC 0x1D
#define PREVENT_ALLOW_MEDIUM_REMOVAL 0x1E
#define READ_FORMAT_CAPACITIES 0x23
#define SET_WINDOW 0x24
#define READ_CAPACITY_10 0x25
#define READ_CAPACITY 0x25
#define READ_CAPACITY_16 0x10
#define READ_CARD_CAPACITY 0x25
#define GET_WINDOW 0x25
#define READ_10 0x28
#define GET_MESSAGE_10 0x28
#define READ_GENERATION 0x29
#define WRITE_10 0x2A
#define SEND_MESSAGE_10 0x2A
#define SEEK_10 0x2B
#define LOCATE_10 0x2B
#define POSITION_TO_ELEMENT 0x2B
#define ERASE_10 0x2C
#define READ_UPDATED_BLOCK 0x2D
#define WRITE_AND_VERIFY_10 0x2E
#define VERIFY_10 0x2F
#define SEARCH_DATA_HIGH_10 0x30
#define SEARCH_DATA_EQUAL_10 0x31
#define OBJECT_POSITION 0x31
#define SEARCH_DATA_LOW_10 0x32
#define SET_LIMITS_10 0x33
#define PRE_FETCH_10 0x34
#define READ_POSITION 0x34
#define GET_DATA_BUFFER_STATUS 0x34
#define SYNCHRONIZE_CACHE_10 0x35
#define LOCK_UNLOCK_CACHE_10 0x36
#define READ_DEFECT_DATA_10 0x37
#define INITIALIZE_ELEMENT_STATUS_WITH_RANGE 0x37
#define MEDIUM_SCAN 0x38
#define COMPARE 0x39
#define COPY_AND_VERIFY 0x3A
#define WRITE_BUFFER 0x3B
#define READ_BUFFER 0x3C
#define UPDATE_BLOCK 0x3D
#define READ_LONG_10 0x3E
#define WRITE_LONG_10 0x3F
#define CHANGE_DEFINITION 0x40
#define WRITE_SAME_10 0x41
#define READ_SUB_CHANNEL 0x42
#define READ_TOC_PMA_ATIP 0x43
#define REPORT_DENSITY_SUPPORT 0x44
#define READ_HEADER 0x44
#define PLAY_AUDIO_10 0x45
#define GET_CONFIGURATION 0x46
#define PLAY_AUDIO_MSF 0x47
#define GET_EVENT_STATUS_NOTIFICATION 0x4A
#define PAUSE_RESUME 0x4B
#define LOG_SELECT 0x4C
#define LOG_SENSE 0x4D
#define STOP_PLAY_SCAN 0x4E
#define XDWRITE_10 0x50
#define XPWRITE_10 0x51
#define READ_DISC_INFORMATION 0x51
#define XDREAD_10 0x52
#define READ_TRACK_INFORMATION 0x52
#define RESERVE_TRACK 0x53
#define SEND_OPC_INFORMATION 0x54
#define MODE_SELECT_10 0x55
#define RESERVE_10 0x56
#define RESERVE_ELEMENT_10 0x56
#define RELEASE_10 0x57
#define RELEASE_ELEMENT_10 0x57
#define REPAIR_TRACK 0x58
#define MODE_SENSE_10 0x5A
#define CLOSE_TRACK_SESSION 0x5B
#define READ_BUFFER_CAPACITY 0x5C
#define SEND_CUE_SHEET 0x5D
#define PERSISTENT_RESERVE_IN 0x5E
#define PERSISTENT_RESERVE_OUT 0x5F
#define variable_length_CDB__more_than_16_bytes 0x7F
#define XDWRITE_EXTENDED_16 0x80
#define WRITE_FILEMARKS_16 0x80
#define REBUILD_16 0x81
#define READ_REVERSE_16 0x81
#define REGENERATE_16 0x82
#define EXTENDED_COPY 0x83
#define RECEIVE_COPY_RESULTS 0x84
#define ATA_COMMAND_PASS_THROUGH_16 0x85
#define ACCESS_CONTROL_IN 0x86
#define ACCESS_CONTROL_OUT 0x87
#define READ_16 0x88
#define WRITE_16 0x8A
#define ORWRITE 0x8B
#define READ_ATTRIBUTE 0x8C
#define WRITE_ATTRIBUTE 0x8D
#define WRITE_AND_VERIFY_16 0x8E
#define VERIFY_16 0x8F
#define PRE_FETCH_16 0x90
#define SYNCHRONIZE_CACHE_16 0x91
#define SPACE_16 0x91
#define LOCK_UNLOCK_CACHE_16 0x92
#define LOCATE_16 0x92
#define WRITE_SAME_16 0x93
#define ERASE_16 0x93
#define _usage_proposed_by_SCSI_Socket_Services_project_ 0x94
#define SERVICE_ACTION_IN_16 0x9E
#define SERVICE_ACTION_OUT_16 0x9F
#define REPORT_LUNS 0xA0
#define ATA_COMMAND_PASS_THROUGH_12 0xA1
#define SECURITY_PROTOCOL_IN 0xA2
#define MAINTENANCE__IN 0xA3
#define SEND_KEY 0xA3
#define MAINTENANCE__OUT 0xA4
#define REPORT_KEY 0xA4
#define MOVE_MEDIUM 0xA5
#define PLAY_AUDIO_12 0xA5
#define EXCHANGE_MEDIUM 0xA6
#define LOAD_UNLOAD_C_DVD 0xA6
#define MOVE_MEDIUM_ATTACHED 0xA7
#define SET_READ_AHEAD 0xA7
#define READ_12 0xA8
#define GET_MESSAGE_12 0xA8
#define SERVICE_ACTION_OUT_12 0xA9
#define WRITE_12 0xAA
#define SEND_MESSAGE_12 0xAA
#define SERVICE_ACTION_IN_12 0xAB
#define ERASE_12 0xAC
#define GET_PERFORMANCE 0xAC
#define READ_DVD_STRUCTURE 0xAD
#define WRITE_AND_VERIFY_12 0xAE
#define VERIFY_12 0xAF
#define SEARCH_DATA_HIGH_12 0xB0
#define SEARCH_DATA_EQUAL_12 0xB1
#define SEARCH_DATA_LOW_12 0xB2
#define SET_LIMITS_12 0xB3
#define READ_ELEMENT_STATUS_ATTACHED 0xB4
#define SECURITY_PROTOCOL_OUT 0xB5
#define REQUEST_VOLUME_ELEMENT_ADDRESS 0xB5
#define SEND_VOLUME_TAG 0xB6
#define SET_STREAMING 0xB6
#define READ_DEFECT_DATA_12 0xB7
#define READ_ELEMENT_STATUS 0xB8
#define READ_CD_MSF 0xB9
#define REDUNDANCY_GROUP__IN 0xBA
#define REDUNDANCY_GROUP__OUT 0xBB
#define SET_CD_SPEED 0xBB
#define SPARE__IN 0xBC
#define SPARE__OUT 0xBD
#define MECHANISM_STATUS 0xBD
#define VOLUME_SET__IN 0xBE
#define READ_CD 0xBE
#define VOLUME_SET__OUT 0xBF
#define SEND_DVD_STRUCTURE 0xBF

/* scsi response status */
#define SCSI_STATUS_GOOD 0
#define SCSI_STATUS_CHECK_CONDITION 2
#define SCSI_STATUS_RESERVATION_CONFLICT 0x18
#define SCSI_STATUS_TASK_ABORTED 0x40

/* scsi status sense descriptor */
#define SCSI_SENSE_DATA_VALID 0x80
#define SCSI_SENSE_DATA_CURENT_ERROR_FIXED_SIZE_DESCRIPTOR 0x70

/* scsi status sense code */
#define SCSI_SENSE_NOSENSE 0
#define SCSI_SENSE_RECOVERED_ERROR 1
#define SCSI_SENSE_NOT_READY 2
#define SCSI_SENSE_MEDIUM_ERROR 3
#define SCSI_SENSE_HARDWARE_ERROR 4
#define SCSI_SENSE_ILLEGAL_REQUEST 5
#define SCSI_SENSE_UNIT_ATTENTION 6
#define SCSI_SENSE_DATA_PROTECT 7
#define SCSI_SENSE_BLANK_CHECK 8
#define SCSI_SENSE_VENDOR_SPECIFIC 0x9
#define SCSI_SENSE_COPY_ABORTED 0xA
#define SCSI_SENSE_ABORTED_COMMAND 0xB

/* scsi status additionnal sense code (asc) aditionnal sense code qualifier (ascq) */
#define SCSI_SENSE_ASC_POWER_ON 0x7300
#define SCSI_SENSE_ASC_INQUIRY_DATA_HAS_CHANGED 0x3F03
#define SCSI_SENSE_ASC_REPORTED_LUNS_DATA_HAS_CHANGED 0x3F0E
#define SCSI_SENSE_ASC_CAPACITY_DATA_HAS_CHANGED 0x2a09
#define SCSI_SENSE_ASC_INVALID_FIELD_IN_CDB 0x2400
#define SCSI_SENSE_ASC_LOGICAL_ADDRESS_OUT_OF_RANGE 0x2100
#define SCSI_SENSE_ASC_WRITE_ERROR 0x0c00
#define SCSI_SENSE_ASC_UNRECOVERED_READ_ERROR 0x1100
#define SCSI_SENSE_ASC_LOGICAL_UNIT_NOT_SUPPORTED 0x2500
#define SCSI_SENSE_ASC_INVALID_COMMAND_OPERATION_CODE 0x2000
#define SCSI_SENSE_ASC_INVALID_RELEASE_OF_PERSISTENT_RESERVATION 0x2604
#define SCSI_SENSE_ASC_RESERVATIONS_RELEASED 0x2a04
#define SCSI_SENSE_ASC_INVALID_FIELD_IN_PARAMETER_LIST 0x2600
#define SCSI_SENSE_ASC_BUS_DEVICE_RESET_FUNCTION_OCCURED 0x2903

/* scsi mode page and mode page flags */

#define MODE_PAGE_MASK 0x3f
#define MODE_PAGE_RETURN_ALL_PAGES 0x3f
#define MODE_SUBPAGE_RETURN_ALL_PAGES 0x00
#define MODE_PAGE_RETURN_ALL_PAGES_AND_SUBPAGES 0x3f
#define MODE_SUBPAGE_RETURN_ALL_PAGES_AND_SUBPAGES 0xff
#define MODE_PAGE_DISCONNECT_RECONNECT 0x02
#define MODE_SUBPAGE_DISCONNECT_RECONNECT 0x00
#define MODE_PAGE_INFORMATIONNAL_EXCEPTIONS_CONTROL 0x1c
#define MODE_SUBPAGE_INFORMATIONNAL_EXCEPTIONS_CONTROL 0x00
#define MODE_PAGE_CACHING_MODE_PAGE 0x08
#define MDOE_PAGE_CONTROL_MODE_PAGE 0x0A
#define MODE_PAGE_PROTOCOL_SPECIFIC_PORT_MODE_PAGE 0x19

#define MODE_SENSE_1Ch_PERF 0x80
#define MODE_SENSE_1Ch_EBF  0x20
#define MODE_SENSE_1Ch_EWASC 0x10
#define MODE_SENSE_1Ch_DEXCPT 0x8
#define MODE_SENSE_1Ch_TEST 0x4
#define MODE_SENSE_1Ch_EBACKERR 0x2
#define MODE_SENSE_1Ch_LOGERR 0x1
#define MODE_SENSE_1Ch_MRIE_NONE 0
#define MODE_SENSE_1Ch_MRIE_GENERATE_UNIT_ATTENTION 0x2
#define MODE_SENSE_1Ch_MRIE_COND_GENERATE_RECOVERED_ERROR 0x3
#define MODE_SENSE_1Ch_MRIE_UNCOND_GENERATE_RECOVERED_ERROR 0x4
#define MODE_SENSE_1Ch_MRIE_GENERATE_NO_SENSE 0x5
#define MODE_SENSE_1Ch_MRIE_ONLY_ON_REQUEST 0x6
#define MODE_SENSE_1Ch_INERVAL_TIMER 100        /* = 100*100ms = 10s */
#define MODE_SENSE_1Ch_MAX_REPORT_COUNT 10

#define MODE_SENSE_CACHING_MODE_IC 0x80
#define MODE_SENSE_CACHING_MODE_ABPF 0x40
#define MODE_SENSE_CACHING_MODE_CAP 0x20
#define MODE_SENSE_CACHING_MODE_DISC 0x10
#define MODE_SENSE_CACHING_MODE_SIZE 0x08
#define MODE_SENSE_CACHING_MODE_WCE 0x04
#define MODE_SENSE_CACHING_MODE_MF 0x2
#define MODE_SENSE_CACHING_MODE_RCD 0x1
#define MODE_SENSE_CACHING_MODE_FSW 0x80
#define MODE_SENSE_CACHING_MODE_LBCSS 0x40
#define MODE_SENSE_CACHING_MODE_DRA 0x20

#define SCSI_SENSE_DOPFUA 0x10
#define SCSI_SENSE_WP 0x80
#define MODE_SENSE_GLTSD 0x2
#define MODE_SENSE_QUEUE_ALGORITHM_MODIFIER_RESTRICTED_REORDERING 0
#define MODE_SENSE_QUEUE_ALGORITHM_MODIFIER_UNRESTRICTED_REORDERING_ALLOWED\
    0x10
#define MODE_SENSE_CONTROL_TST_LOGICAL_UNIT_MAINTAINS_ONE_TASK_SET_FOR_ALL_I_T_NEXUS 0x00
#define MODE_SENSE_CONTROL_TST_LOGICAL_UNIT_MAINTAINS_SEPARATE_TASK_SETS_FOR_EACH_I_T_NEXUS 0x20
#define MODE_SENSE_CONTROL_TAS 0x40

/* scsi inquiry with no vpd */
#define SEANODES_IEEE_COMPANY_ID_OUI 0x0024F0
#define INQUIRY_VERSION_SPC 0x3
#define INQUIRY_VERSION_SPC2 0x4
#define INQUIRY_VERSION_SPC3 0x5
#define INQUIRY_RESPONSE_DATA_SCSI3 0x2
#define INQUIRY_RMB 0x80
#define INQUIRY_HISUP 0x10
#define INQUIRY_NORMACA 0x20
#define INQUIRY_AERC 0x80
#define INQUIRY_PROTECT 0x1
#define INQUIRY_3PC 0x08
#define INQUIRY_ACC 0x40
#define INQUIRY_SCCS 0x80
#define INQUIRY_MCHNGR 0x8
#define INQUIRY_MULTIP 0x10
#define INQUIRY_VS1 0x20
#define INQUIRY_ENCSERV 0x40
#define INQUIRY_BQUE 0x80
#define INQUIRY_VS2 0x1
#define INQUIRY_CMDQUE 0x2
#define INQUIRY_LINEKED 0x8
#define INQUIRY_VERSION_DESCRIPTOR_SPC3_T10_1416_D_R23 0x312
#define INQUIRY_VERSION_DESCRIPTOR_SPC3_ANSI_INCITS_408_2005 0x314

/* scsi inquiry page and inquiry page flags */
#define INQUIRY_PAGE_SUPORTED_VPD_PAGE 0x00
#define INQUIRY_PAGE_UNIT_SERIAL_NUMBER 0x80
#define INQUIRY_PAGE_DEVICE_IDENTIFICATION 0x83
#define INQUIRY_PAGE_BLOCKS_LIMIT 0xB0

#define INQUIRY_PERIPHERAL_QUALIFIER_CONNECTED 0x0
#define INQUIRY_PERIPHERAL_QUALIFIER_CAPABLE 0x1
#define INQUIRY_PERIPHERAL_QUALIFIER_NOT_CAPABLE 0x3
#define INQUIRY_PERIPHERAL_DEVICE_TYPE_SBC 0x0
#define INQUIRY_PERIPHERAL_DEVICE_TYPE_WELL_KNOWN_LU 0x1e
#define INQUIRY_PERIPHERAL_DEVICE_TYPE_UNKNOWN 0x1f

#define INQUIRY_VERSION_DESCRIPTOR_ISCSI_NO_VERSION_CLAIMED 0x960
#define INQUIRY_VERSION_DESCRIPTOR_SBC_T10_0999_D_08b 0x19c

#define INQUIRY_CODE_SET_BINARY 1
#define INQUIRY_CODE_SET_ASCII 2
#define INQUIRY_CODE_SET_UTF8 3

#define INQUIRY_ASSOCIATION_LUN 0
#define INQUIRY_ASSOCIATION_TARGET_PORT 1
#define INQUIRY_ASSOCIATION_TARGET_DEVICE 2

#define INQUIRY_TYPE_VENDOR_SPECIFIC 0
#define INQUIRY_TYPE_T10_VENDOR_ID 1
#define INQUIRY_TYPE_EUI64 2
#define INQUIRY_TYPE_NAA 3
#define INQUIRY_TYPE_RELATIVE_TARGET_PORT_ID 4
#define INQUIRY_TYPE_TARGET_PORT_GROUP 5
#define INQUIRY_TYPE_LUN_GROUP 6
#define INQUIRY_TYPE_MD5_LUN_ID 7
#define INQUIRY_TYPE_SCSI_NAME 8

#define INQUIRY_NAA_IEEE_EXTENDED 0x2
#define INQUIRY_NAA_IEEE_REGISTERED 0x5
#define INQUIRY_NAA_IEEE_REGISTERED_EXTENDED 0x6
#define INQUIRY_NAA_IEEE_EXTENDED_SIZE 8


#define INQUIRY_PROTOCOL_FC_FCP2 0
#define INQUIRY_PROTOCOL_PSCSI_SPI5 1
#define INQUIRY_PROTOCOL_SSA_S3P 2
#define INQUIRY_PROTOCOL_IEEE1394_SBP3 3
#define INQUIRY_PROTOCOL_SRP 4
#define INQUIRY_PROTOCOL_ISCSI 5
#define INQUIRY_PROTOCOL_SAS 6
#define INQUIRY_PROTOCOL_ADT 7
#define INQUIRY_PROTOCOL_ATA7 8

/* struct used for the end of a scsi command */
typedef struct scsi_command_status
{
    int           status;
    unsigned int  length_out;
    int           done;
    unsigned int  sense;
    unsigned long asc_ascq;
} scsi_command_status_t;

#define SCSI_STATUS_OK(scsi_status, length)  \
    do { \
        (scsi_status)->length_out = length; \
        (scsi_status)->done = 1; \
        (scsi_status)->status = 0; \
    } while (0)
#define SCSI_STATUS_ERROR(scsi_status, cond_st, sense_st, asc_ascq_st) \
    do { \
        (scsi_status)->done = 1; \
        (scsi_status)->status = cond_st; \
        (scsi_status)->sense = sense_st; \
        (scsi_status)->asc_ascq = asc_ascq_st; \
    } while (0)

#endif  /* SCSI_H */
